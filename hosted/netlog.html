<!DOCTYPE html>
<html lang="en">
<head> <meta charset="utf-8">
<title>LoL Netlog parser</title>
<script src="d3.v3.min.js" charset="utf-8"></script>
<style type="text/css">

html, body { height: 100%; }
body { margin: 0; font-family: Helvetica, Arial, sans; }
#help {
    width: 100%; height: 100%;
    background-color: #ddd; color: #444;
    text-align: center; padding-top: 100px;
}
#results {
    width: 100%; height: 100%;
    background-color: #fff;
    margin: 8px;
    display: none;
}

</style>
</head>

<body>
<div id="help">
<h1>LoL Netlog parser</h1>
<h2>Drop a log file on this web page</h2>
<p>On Windows, look in <tt>C:\Riot Games\League of Legends\Logs\Network Logs</tt></p>
<p>On a Mac, open a Finder window, press &#8984;-Shift-G, and paste in<br>
<tt>/Applications/League of Legends.app/Contents/LOL/Logs/Network Logs</tt></p>
<p>Or <a title="load demo" href="#" onclick="loadDemo();return false;">click here</a> to load a demo file</a>
<h3>By Nelson Minar <a href="mailto:nelson@monkey.org">&lt;nelson@monkey.org&gt;</a>
</div>
<div id="results">
<h1>Log results</h1>
<div><span id="gameLength"></span> minutes</div>
<div><span id="incoming"></span> bytes/s in</div>
<div><span id="outgoing"></span> bytes/s out</div>
<div><span id="cumulativeLoss"></span> packets lost<div>
<div><span id="lossPerSec"></span> packets/s lost</div>

<script type="text/javascript">


var dropzone = document.getElementById("help");
dropzone.addEventListener("dragenter", cancelEvent, false);
dropzone.addEventListener("dragover", cancelEvent, false);
dropzone.addEventListener("drop", drop, false);

// Handler to cancel an event
function cancelEvent(e) { e.stopPropagation(); e.preventDefault(); }

// The drop event handler. Only properly handles files.
function drop(e) {
    // Pick out the file object we want. Could be multiple files; we only take first.
    var files = e.dataTransfer.files;
    var file = files[0];

    // Cancel the drop event propagation. Note this clobbers the data in the event.
    cancelEvent(e);

    // Read in the file and hand it off to our application function
    var reader = new FileReader();
    reader.onloadend = function(e) {
        // Very basic error handling
        if (e.target.error) {
            console.log("Error loading file", e.target.error);
            return;
        }
        // Grab the file contents from the event
        var fileContents = e.target.result;
        processFile(fileContents);
    }

    // Fire off the actual read process.
    reader.readAsText(file);
}

// Load a canned log file as a demo
function loadDemo() {
    d3.text("demo.txt", function(error, data) {
        if (error) {
            console.log("Demo failed", error);
            return;
        }
        processFile(data);
    });
}

// Pull just the CSV data out of the logfile
// Input format is:
// [time], [address], [incoming], [outgoing], [app_ctos], [app_stoc], [loss], [sent], [ping], [variance], [reliable delayed], [unreliable delayed], [app update delayed], [Time spent in critical section (frame)]
// Output: array of row objects.
function extract(data) {
    var result = [];
    // CSV data starts with a number and a comma
    var parseRE = new RegExp("^\\d+,.*$", "gm");
    var match = null;
    var lastLoss = 0;

    // Loop through lines that look like CSV data
    while (match = parseRE.exec(data)) {
        // Split the row by comma
        var cols = match[0].split(',');
        // Derive the incremental loss in this report
        var cumulativeLoss = +cols[6];
        var incrementalLoss = cumulativeLoss - lastLoss;
        lastLoss = cumulativeLoss;
        // Construct a result object
        result.push({
            time: +cols[0],
            ping: +cols[8],
            cumulativeLoss: +cols[6],
            incrementalLoss: incrementalLoss,
            incoming: +cols[2],
            outgoing: +cols[3]});
    }

    return result;
}

// Demo function to handle data from the file dropped in
function processFile(dataText) {
    var data = extract(dataText);
    var lastRow = data[data.length - 1];
    var matchLength = lastRow.time / 1000;

    d3.select("#gameLength").text(Math.round(matchLength/60));
    d3.select("#incoming").text(Math.round(lastRow.incoming/matchLength));
    d3.select("#outgoing").text(Math.round(lastRow.outgoing/matchLength));
    d3.select("#cumulativeLoss").text(lastRow.cumulativeLoss);
    d3.select("#lossPerSec").text((lastRow.cumulativeLoss/matchLength).toFixed(2));

    console.log("Packet losses", data.map(function(r) { return r.incrementalLoss; }).join(' '));

    // Hide the "drop file" prompting
    dropzone.style.display = "none";

    // Display the contents of the file
    var display = document.getElementById("results");
    display.style.display = "block";
}

</script>
</body></html>
